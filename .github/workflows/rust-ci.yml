name: rust-ci

on:
  push:
    branches: [ main ]
    tags: [ '*' ]
  workflow_dispatch:

permissions:
  id-token: write
  contents: write
  checks: write

env:
  CARGO_TERM_COLOR: always
  PROJECT_NAME: hello-blea

jobs:
  build:
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest

    runs-on: ${{ matrix.os }}

    steps:
      - name: 🌩️ Checkout repository
        uses: actions/checkout@v3

      - name: 🧰 Install dependencies
        if: ${{ runner.os == 'Linux' }}
        run: |
          sudo apt-get update
          sudo apt-get install libdbus-1-dev

      - name: 🔧 Cache packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: 🔩Test
        run: cargo test

      - name: 🔍 Run clippy
        uses: actions-rs/clippy-check@v1
        if: ${{ runner.os == 'Linux' }}
        with:
          name: clippy ${{ matrix.os }}
          token: ${{ github.token }}
          args: --all-features

      - name: 📦 Build
        run: |
          cargo build --all --release

      - name: ✂️ Strip symbols
        if: ${{ runner.os != 'Windows' }}
        run: |
          strip target/release/${PROJECT_NAME}

      - uses: actions/upload-artifact@v3
        if: ${{ runner.os != 'Windows' }}
        with:
          name: ${{ runner.os }}_amd64
          path: target/release/${{ env.PROJECT_NAME }}
          retention-days: 7

      - uses: actions/upload-artifact@v3
        if: ${{ runner.os == 'Windows' }}
        with:
          name: ${{ runner.os }}_amd64
          path: target/release/${{ env.PROJECT_NAME }}.exe
          retention-days: 7

  build-macos-arm:
    runs-on: macos-11
    steps:
      - name: 🌩️ Checkout repository
        uses: actions/checkout@v3

      - name: 🔧 Cache packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: 📚️ Install target
        run: |
          rustup update
          rustup target add aarch64-apple-darwin

      - name: 📦 Build
        run: cargo build --all --release --target=aarch64-apple-darwin

      - run: ls target/release/

      - uses: actions/upload-artifact@v3
        with:
          name: ${{ runner.os }}_arm64
          path: target/aarch64-apple-darwin/release/${{ env.PROJECT_NAME }}
          retention-days: 7

  release:
    needs: [ build, build-macos-arm ]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - name: 🌩️ Checkout repository
        uses: actions/checkout@v3

      - uses: actions/download-artifact@v3
        with:
          name: Linux_amd64

      - uses: actions/download-artifact@v3
        with:
          name: macOS_amd64

      - uses: actions/download-artifact@v3
        with:
          name: macOS_arm64

      - uses: actions/download-artifact@v3
        with:
          name: Windows_amd64

      - run: ls

      - name: 🚀 Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            Linux_amd64
            Windows_amd64
            macOS_amd64
            macOS_arm64
        env:
          GITHUB_TOKEN: ${{ github.token }}
